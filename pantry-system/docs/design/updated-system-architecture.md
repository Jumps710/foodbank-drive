# フードパントリー予約システム 更新版設計書

## 1. システム概要

### 目的
- Google Formベースの予約システムをGAS Web Appに移行
- パントリー管理・予約管理の自動化と効率化
- 利用者データの分析・可視化・ログ管理

### 主要機能
1. **予約フォーム** - Google Form代替のWebフォーム
2. **パントリー管理** - 開催イベントの作成・管理
3. **予約状況管理** - 予約の閲覧・キャンセル処理
4. **レポート・ダッシュボード** - 利用傾向の分析・可視化
5. **ログ管理** - システムイベントの記録・監視

## 2. 更新されたシステム構成

```
┌─────────────────────────────────────────────────────┐
│                    Google Apps Script                 │
├─────────────────────────────────────────────────────┤
│  Web App (doGet/doPost)                             │
│  ├── 予約フォーム (HTML/CSS/JS)                     │
│  ├── 管理ダッシュボード (HTML/CSS/JS)               │
│  ├── パントリー管理 (HTML/CSS/JS)                   │
│  ├── 予約状況管理 (HTML/CSS/JS)                     │
│  └── ログ管理 (HTML/CSS/JS)                        │
├─────────────────────────────────────────────────────┤
│  Server Functions                                    │
│  ├── pantry.gs (パントリー管理)                     │
│  ├── reservation.gs (予約処理)                      │
│  ├── user.gs (ユーザー管理)                        │
│  ├── analytics.gs (分析・レポート)                  │
│  ├── logger.gs (ログ管理)                          │
│  └── utils.gs (共通ユーティリティ)                  │
├─────────────────────────────────────────────────────┤
│  Data Layer (Google Sheets)                         │
│  ├── Pantries シート (パントリー管理)               │
│  ├── Users シート (利用者管理)                      │
│  ├── Reservations シート (予約管理)                 │
│  ├── Usage_History シート (利用履歴)                │
│  ├── Event_Logs シート (システムログ)               │
│  └── Settings シート (システム設定)                 │
└─────────────────────────────────────────────────────┘
```

## 3. 管理画面の機能構成

### 3.1 パントリー管理
- **パントリー作成**: 開催日、場所、容量、案内文等の設定
- **パントリー一覧**: 作成済みパントリーの一覧・編集・削除
- **パントリーID**: `YY.MM.DD.開催場所名` 形式での管理

### 3.2 予約状況
- **予約一覧**: パントリー別の予約状況閲覧
- **予約キャンセル**: 個別予約の取り消し機能
- **統計表示**: 時間帯別集計、予約率等の表示
- **データ出力**: PDF/Excel/印刷用画面への出力

### 3.3 レポート
#### ダッシュボード
- 全利用者数、利用者数遷移の折れ線グラフ
- 利用者ベストテン、世帯構成の割合パイチャート
- 年度（4月-3月）、年別（1月-12月）、開催場所でのフィルター機能

#### 過去の利用履歴
- 全利用履歴の閲覧
- 開催月、場所、ユーザーでのフィルター・ソート機能

### 3.4 ログ管理
- **イベントログ集計**: 予約完了、エラー等の検知・記録
- **ログ閲覧**: 日時、レベル、イベントタイプでのフィルター
- **CSVエクスポート**: ローカルへのデータエクスポート
- **自動削除**: 古いログの定期削除機能

## 4. データフロー

### 4.1 パントリー作成フロー
1. 管理者がパントリー管理画面で新規作成
2. パントリーIDの自動生成（日付+場所）
3. Pantriesシートへの保存
4. 予約フォームの自動更新

### 4.2 予約フロー
1. 利用者が予約フォームにアクセス
2. カタカナ氏名による既存ユーザー検索
3. ユーザー情報の更新または新規作成
4. 予約情報のReservationsシートへの保存
5. Event_Logsへのログ記録
6. 確認メール送信（メールアドレスがある場合）

### 4.3 分析・レポートフロー
1. 定期的なUsage_Historyシートの更新
2. 各種統計データの計算・キャッシュ
3. ダッシュボードでの可視化
4. フィルター条件に応じたデータ抽出

## 5. セキュリティ・運用考慮事項

### 5.1 認証・アクセス制御
- 管理画面は管理者キーによる認証必須
- Google Sheetsの共有設定の適切な管理
- 予約フォームはreCAPTCHAで保護

### 5.2 データ保護
- 個人情報の適切な管理・保護
- ログデータの定期的な削除
- バックアップ・復旧手順の整備

### 5.3 監視・メンテナンス
- システムエラーの自動検知・通知
- パフォーマンス監視
- 定期的なデータベース最適化

## 6. 実装優先度

### Phase 1 (高優先度)
1. パントリー管理機能
2. 予約フォーム・予約状況管理
3. 基本的なユーザー管理・識別

### Phase 2 (中優先度)
1. ダッシュボード・分析機能
2. ログ管理・監視機能
3. データ出力・印刷機能

### Phase 3 (低優先度)
1. 高度なフィルター・検索機能
2. 自動化・通知機能の拡張
3. UI/UXの改善・最適化

## 7. 技術仕様

### 7.1 フロントエンド
- HTML5/CSS3/JavaScript (ES6+)
- レスポンシブデザイン対応
- Chart.js for データ可視化

### 7.2 バックエンド
- Google Apps Script
- Google Sheets as Database
- Gmail API for 通知メール

### 7.3 デプロイ・CI/CD
- Google Apps Script CLI (clasp)
- Git管理
- 自動デプロイパイプライン